# 지하철 실시간 위치 기반 채팅 시스템

## 구현된 기능

### 🚇 핵심 기능
1. **실시간 열차 위치 조회**: 서울 지하철 OpenAPI를 통한 실시간 열차 위치 정보 수집
2. **근접 탐지**: 사용자 위치 기준 100m 이내 열차 자동 탐지
3. **자동 채팅방 생성**: 근처 열차에 대한 채팅방 자동 표시
4. **거리 모니터링**: 15분마다 위치 체크 및 거리 경고/자동 퇴장

### 📱 사용자 인터페이스
- **채팅방 리스트**: 근처 지하철 채팅방과 일반 채팅방 분리 표시
- **실시간 표시**: 지하철 채팅방에 LIVE 표시 및 노선별 색상 구분
- **거리 정보**: 각 열차와의 거리 표시 (미터 단위)
- **Pull-to-refresh**: 수동으로 근처 지하철 새로고침 가능

### ⚠️ 안전 기능
- **거리 경고**: 열차와 100m 이상 떨어지면 첫 번째 경고
- **자동 퇴장**: 두 번째 거리 위반 시 채팅방에서 자동 퇴장
- **권한 관리**: 위치 권한 요청 및 설정 안내

## 기술 구현

### 🏗️ 아키텍처
```
lib/
├── services/
│   ├── subway_service.dart     # 지하철 API 연동
│   ├── location_service.dart   # 위치 서비스 (확장됨)
│   └── ...
├── screens/
│   ├── chat_room_list_screen.dart  # 채팅방 목록 (업데이트됨)
│   ├── chat_room_screen.dart       # 채팅방 (업데이트됨)
│   └── ...
└── widgets/
    └── ... (기존 위젯들)
```

### 🔧 주요 클래스

#### SubwayService
- 서울 지하철 OpenAPI 연동
- 실시간 열차 위치 정보 조회
- 근접 탐지 및 거리 계산
- 16개 노선 지원 (1~9호선, 중앙선, 경춘선 등)

#### LocationService (확장)
- 기존 위치 서비스에 지하철 기능 추가
- 15분 주기 위치 모니터링
- 근처 열차 자동 검색
- 채팅방 입장/퇴장 관리
- 거리 경고 시스템

#### TrainPosition 모델
```dart
class TrainPosition {
  final String? trainNo;        // 열차번호
  final String? subwayNm;       // 노선명
  final String? statnNm;        // 현재 역명
  final String? updnLine;       // 상하행 구분
  final double? latitude;       // 위도 (역 기준)
  final double? longitude;      // 경도 (역 기준)
  double? distanceFromUser;     // 사용자와의 거리
  
  String get chatRoomId;        // 채팅방 ID (trainNo_subwayNm)
  String get displayName;       // 표시명
}
```

### 🌐 API 사용
```
서울시 지하철 실시간 위치정보 API
URL: http://swopenAPI.seoul.go.kr/api/subway/{KEY}/json/realtimePosition/1/100/{노선명}
KEY: 705646567a6a61653732666d436b6a
```

## 사용 흐름

### 📍 1단계: 위치 권한 및 서비스 초기화
- 앱 시작 시 위치 권한 요청
- 위치 서비스 초기화 및 15분 주기 모니터링 시작

### 🔍 2단계: 근처 열차 탐지
- 사용자 현재 위치 기준 100m 이내 열차 검색
- 16개 노선 실시간 위치 정보 병렬 조회
- 거리순 정렬하여 표시

### 💬 3단계: 채팅방 입장
- 근처 열차 채팅방 클릭 시 자동 입장
- 열차 정보 위치 서비스에 등록
- 실시간 거리 모니터링 시작

### ⚠️ 4단계: 거리 모니터링
- 15분마다 현재 위치와 열차 위치 비교
- 100m 이상 떨어질 시:
  - 1차: 경고 메시지
  - 2차: 자동 퇴장 및 채팅방 리스트로 이동

## 기능 제한사항

### 🚧 현재 제한사항
1. **역 위치 근사값**: API에서 정확한 위도/경도를 제공하지 않아 주요 역 좌표를 하드코딩
2. **테스트 환경**: 실제 지하철 근처에서 테스트 필요
3. **네트워크 의존**: 실시간 API 호출로 네트워크 연결 필수

### 💡 개선 가능 사항
1. **정확한 역 좌표**: 전체 지하철역 정확한 좌표 DB 구축
2. **캐싱 시스템**: API 응답 캐싱으로 성능 최적화
3. **오프라인 모드**: 네트워크 끊김 시 대체 로직
4. **푸시 알림**: 근처 열차 감지 시 알림

## 테스트 방법

### 🧪 개발 테스트
1. **시뮬레이터**: GPS 시뮬레이션으로 지하철역 좌표 입력
2. **실제 디바이스**: 지하철역 근처에서 실제 테스트
3. **API 테스트**: Postman 등으로 API 응답 확인

### 📍 시뮬레이션 좌표 (테스트용)
- 강남역: 37.4979, 127.0276
- 홍대입구: 37.5564, 126.9226
- 서울역: 37.5546, 126.9707

## 보안 고려사항

### 🔒 개인정보 보호
- 위치 정보는 로컬에서만 처리
- 서버에 위치 정보 전송하지 않음
- 채팅 메시지에 위치 정보 포함하지 않음

### 🛡️ API 보안
- API 키 노출 (향후 환경변수로 이동 필요)
- HTTPS 사용 (API가 HTTP인 점 개선 필요)

---

## 🚀 사용 방법

1. **앱 실행**: 위치 권한 허용
2. **채팅방 리스트**: Pull-to-refresh로 근처 지하철 검색
3. **채팅방 입장**: 원하는 지하철 채팅방 선택
4. **채팅 참여**: 같은 열차 승객들과 채팅
5. **자동 퇴장**: 열차에서 멀어지면 자동으로 나가짐

## 📞 문의사항
구현 관련 문의나 개선사항이 있으시면 언제든 말씀해 주세요!